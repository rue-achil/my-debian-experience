#!/usr/bin/env bash


# Weather codes and their corresponding icons
declare -A WEATHER_CODES=(
    ["113"]="‚òÄÔ∏è"
    ["116"]="‚õÖ"
    ["119"]="‚òÅÔ∏è"
    ["122"]="‚òÅÔ∏è"
    ["143"]="‚òÅÔ∏è"
    ["176"]="üåßÔ∏è"
    ["179"]="üåßÔ∏è"
    ["182"]="üåßÔ∏è"
    ["185"]="üåßÔ∏è"
    ["200"]="‚õàÔ∏è"
    ["227"]="üå®Ô∏è"    
    ["230"]="üå®Ô∏è"
    ["248"]="‚òÅÔ∏è"
    ["260"]="‚òÅÔ∏è"
    ["263"]="üåßÔ∏è"
    ["266"]="üåßÔ∏è"
    ["281"]="üåßÔ∏è"
    ["284"]="üåßÔ∏è"
    ["293"]="üåßÔ∏è"
    ["296"]="üåßÔ∏è"
    ["299"]="üåßÔ∏è"
    ["302"]="üåßÔ∏è"
    ["305"]="üåßÔ∏è"
    ["308"]="üåßÔ∏è"
    ["311"]="üåßÔ∏è"
    ["314"]="üåßÔ∏è"
    ["317"]="üåßÔ∏è"
    ["320"]="üå®Ô∏è"
    ["323"]="üå®Ô∏è"
    ["326"]="üå®Ô∏è"
    ["329"]="‚ùÑÔ∏è"
    ["332"]="‚ùÑÔ∏è"
    ["335"]="‚ùÑÔ∏è"
    ["338"]="‚ùÑÔ∏è"
    ["350"]="üåßÔ∏è"
    ["353"]="üåßÔ∏è"
    ["356"]="üåßÔ∏è"
    ["359"]="üåßÔ∏è"
    ["362"]="üåßÔ∏è"
    ["365"]="üåßÔ∏è"
    ["368"]="üåßÔ∏è"
    ["371"]="‚ùÑÔ∏è"
    ["374"]="üå®Ô∏è"
    ["377"]="üå®Ô∏è"
    ["386"]="üå®Ô∏è"
    ["389"]="üå®Ô∏è"
    ["392"]="üåßÔ∏è"
    ["395"]="‚ùÑÔ∏è"
)

# Fetch weather data
WEATHER_DATA=$(curl -s "wttr.in/Casablanca?format=j1")
CURL_EXIT=$?

# Check for curl or jq error or empty data
if [ $CURL_EXIT -ne 0 ] || [ -z "$WEATHER_DATA" ] || ! echo "$WEATHER_DATA" | jq . >/dev/null 2>&1; then
    # Show just a default icon (cloud) if error
    echo '{"text": "‚òÅÔ∏è", "tooltip": ""}'
    exit 0
fi

# Extract current conditions
CURRENT_TEMP=$(echo "$WEATHER_DATA" | jq -r '.current_condition[0].temp_C')
FEELS_LIKE=$(echo "$WEATHER_DATA" | jq -r '.current_condition[0].FeelsLikeC')
WEATHER_CODE=$(echo "$WEATHER_DATA" | jq -r '.current_condition[0].weatherCode')
WEATHER_DESC=$(echo "$WEATHER_DATA" | jq -r '.current_condition[0].weatherDesc[0].value')
WIND_SPEED=$(echo "$WEATHER_DATA" | jq -r '.current_condition[0].windspeedKmph')
HUMIDITY=$(echo "$WEATHER_DATA" | jq -r '.current_condition[0].humidity')

# Get weather icon
ICON="${WEATHER_CODES["$WEATHER_CODE"]:-"‚òÅÔ∏è"}"

# Format temperature with + for positive single digits
if [[ "$FEELS_LIKE" =~ ^-?[0-9]+\.?[0-9]*$ ]]; then
    TEMP_INT=${FEELS_LIKE%.*}
    EXTRA_CHAR=""
    if [ "$TEMP_INT" -gt 0 ] && [ "$TEMP_INT" -lt 10 ]; then
        EXTRA_CHAR="+"
    fi
else
    TEMP_INT=0
    EXTRA_CHAR=""
fi

# Create JSON output
TEXT="$ICON ${EXTRA_CHAR}${FEELS_LIKE}¬∞C"
TOOLTIP="<b>${WEATHER_DESC} ${CURRENT_TEMP}¬∞C</b>\nFeels like: ${FEELS_LIKE}¬∞C\nWind: ${WIND_SPEED}Km/h\nHumidity: ${HUMIDITY}%"

# Output JSON
echo "{\"text\": \"$TEXT\", \"tooltip\": \"$TOOLTIP\"}"